<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Holdings.me Portfolio Builder</title>

    <!-- Performance: Preconnect to external APIs -->
    <link rel="preconnect" href="https://query1.finance.yahoo.com">

    <!-- Minimal favicon to avoid 404s -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“ˆ</text></svg>">
    <meta name="theme-color" content="#007aff">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f7; color: #333; }
        @media (prefers-color-scheme: dark) { body { background: #1a1a1a; color: #f9fafb; } }
        .container { max-width: 900px; margin: 0 auto; padding: 16px; }
        
        .branding { text-align: center; margin-bottom: 32px; padding: 20px 0; border-bottom: 1px solid #e2e8f0; }
        @media (prefers-color-scheme: dark) { .branding { border-bottom-color: #374151; } }
        .logo-container { display: inline-flex; align-items: center; background: rgba(15, 23, 42, 0.04); padding: 16px 24px; border-radius: 16px; margin-bottom: 16px; border: 1px solid rgba(15, 23, 42, 0.08); }
        @media (prefers-color-scheme: dark) { .logo-container { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.2); } }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%); border-radius: 50%; margin-right: 12px; position: relative; }
        .logo-icon::before { content: ''; position: absolute; width: 16px; height: 3px; background: white; border-radius: 1px; top: 8px; left: 50%; transform: translateX(-50%); }
        .logo-icon::after { content: ''; position: absolute; width: 12px; height: 3px; background: rgba(255,255,255,0.7); border-radius: 1px; top: 15px; left: 50%; transform: translateX(-50%); }
        .chart-line { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 8px; height: 3px; background: rgba(255,255,255,0.4); border-radius: 1px; }
        .logo { font-size: 1.75rem; font-weight: 800; color: #0f172a; letter-spacing: -0.5px; }
        .domain { font-size: 1.75rem; font-weight: 400; color: #64748b; letter-spacing: -0.5px; }
        @media (prefers-color-scheme: dark) { .logo { color: #f8fafc; } }
        .tagline { font-size: 0.875rem; color: #64748b; margin-bottom: 12px; }
        @media (prefers-color-scheme: dark) { .tagline { color: #94a3b8; } }
        
        .page-title { text-align: center; font-size: 1.8rem; font-weight: 600; margin-bottom: 25px; }
        @media (prefers-color-scheme: dark) { .page-title { color: #f9fafb; } }
        .form-section { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        @media (prefers-color-scheme: dark) { .form-section { background: #2a2a2a; } }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; }
        @media (prefers-color-scheme: dark) { .section-title { color: #f9fafb; } }
        .section-subtitle { font-size: 0.9rem; color: #6b7280; margin-bottom: 20px; }
        @media (prefers-color-scheme: dark) { .section-subtitle { color: #9ca3af; } }
        
        .spreadsheet { border: 1px solid #e5e7eb; border-radius: 8px; background: white; overflow: hidden; margin-bottom: 20px; }
        @media (prefers-color-scheme: dark) { .spreadsheet { background: #1f1f1f; border-color: #404040; } }
        .spreadsheet-header { display: grid; grid-template-columns: 2fr 1.5fr 60px 50px; background: #f8f9fa; font-weight: 600; font-size: 0.9rem; color: #6b7280; }
        @media (prefers-color-scheme: dark) { .spreadsheet-header { background: #333333; color: #a1a1aa; } }
        .spreadsheet-header div { padding: 12px 8px; border-right: 1px solid #e5e7eb; text-align: center; }
        @media (prefers-color-scheme: dark) { .spreadsheet-header div { border-right-color: #404040; } }
        .spreadsheet-header div:first-child { text-align: left; }
        .spreadsheet-header div:last-child { border-right: none; }
        .spreadsheet-row { display: grid; grid-template-columns: 2fr 1.5fr 60px 50px; border-bottom: 1px solid #f1f3f4; }
        @media (prefers-color-scheme: dark) { .spreadsheet-row { border-bottom-color: #404040; } }
        .spreadsheet-row:hover { background: #f9fafb; }
        @media (prefers-color-scheme: dark) { .spreadsheet-row:hover { background: #404040; } }
        .spreadsheet-cell { padding: 8px; border-right: 1px solid #f1f3f4; display: flex; align-items: center; justify-content: center; }
        @media (prefers-color-scheme: dark) { .spreadsheet-cell { border-right-color: #404040; } }
        .spreadsheet-cell:first-child { justify-content: flex-start; }
        .spreadsheet-cell:last-child { border-right: none; }
        .cell-input { width: 100%; border: none; background: transparent; padding: 6px; font-size: 14px; outline: none; text-align: center; color: inherit; }
        .cell-input:first-child { text-align: left; }
        .cell-input:focus { background: rgba(255,255,255,0.1); border: 2px solid #667eea; border-radius: 4px; }
        .cell-input.valid { border: 2px solid #34c759; border-radius: 4px; }
        .cell-input.invalid { border: 2px solid #ff3b30; border-radius: 4px; }
        .cell-input.validating { border: 2px solid #007aff; border-radius: 4px; }
        @media (prefers-color-scheme: dark) { .cell-input:focus { background: #2a2a2a; color: #f9fafb; } }
        
        .category-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #e5e7eb; cursor: pointer; }
        @media (prefers-color-scheme: dark) { .category-dot { border-color: #6b7280; } }
        .color-none { background: transparent; }
        .color-stocks { background: #0173b2; }
        .color-etfs { background: #029e73; }
        .color-crypto { background: #d55e00; }
        .color-bonds { background: #cc78bc; }
        .color-reits { background: #ca9161; }
        .color-commodities { background: #fbafe4; }
        
        .delete-btn { background: transparent; border: none; color: #dc2626; cursor: pointer; font-size: 16px; opacity: 0.7; }
        .delete-btn:hover { opacity: 1; }
        @media (prefers-color-scheme: dark) { .delete-btn { color: #ef4444; } }
        .add-btn { background: #f3f4f6; color: #6b7280; border: 2px dashed #d1d5db; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; }
        .add-btn:hover { background: #e5e7eb; }
        @media (prefers-color-scheme: dark) { .add-btn { background: #374151; color: #9ca3af; border-color: #4b5563; } .add-btn:hover { background: #4b5563; } }
        
        .groups-display { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; min-height: 40px; }
        .group-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 16px; font-size: 13px; color: white; cursor: grab; transition: transform 0.2s, box-shadow 0.2s; }
        .group-tag:active { cursor: grabbing; }
        .group-tag.dragging { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.3); opacity: 0.8; z-index: 1000; }
        .group-tag.drag-over { transform: translateX(4px); }
        .drag-handle { margin-right: 4px; opacity: 0.7; font-size: 10px; line-height: 1; }
        .group-delete { background: rgba(255,255,255,0.3); border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; color: white; }
        .group-input { flex: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; color: #374151; }
        @media (prefers-color-scheme: dark) { .group-input { background: #2a2a2a; border-color: #6b7280; color: #f9fafb; } }
        .group-input-container { display: flex; gap: 10px; }
        .add-group-btn { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; }
        
        .duration-select, .email-input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; color: #374151; }
        @media (prefers-color-scheme: dark) { .duration-select, .email-input { background: #2a2a2a; border-color: #6b7280; color: #f9fafb; } }
        .submit-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 18px 40px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .submit-btn:active { transform: translateY(0px); transition: transform 0.05s; }
        .delete-btn { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; border: none; padding: 18px 40px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 20px; }
        .delete-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4); }
        .row-delete { background: #ff3b30; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .row-delete:hover { background: #d70015; }
        .drag-handle-row { cursor: move; color: #9ca3af; font-size: 12px; user-select: none; margin-right: 8px; padding: 4px; }
        .spreadsheet-row.dragging { opacity: 0.5; }
        .spreadsheet-row { transition: all 0.1s ease; }
        .info-icon { color: #6b7280; cursor: pointer; margin-left: 6px; font-size: 14px; font-weight: normal; position: relative; }
        .info-icon:hover { color: #374151; }
        .info-icon:hover::after {
            content: "Click for ticker help";
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }

        /* Mobile app-style touch behaviors */
        * {
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }
        *:focus {
            outline: none;
        }
        body {
            -webkit-text-size-adjust: 100%;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
        }
        input, select, textarea, button {
            -webkit-user-select: auto;
            user-select: auto;
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="branding">
            <div class="logo-container">
                <div class="logo-icon"><div class="chart-line"></div></div>
                <span class="logo">Holdings</span><span class="domain">.me</span>
            </div>
            <div class="tagline">Portfolio snapshot, simplified</div>
        </div>

        <h1 class="page-title">Create Portfolio</h1>

        <div class="form-section">
            <h2 class="section-title">Holdings</h2>
            <p class="section-subtitle">Enter your portfolio holdings below</p>
            
            <div class="spreadsheet">
                <div class="spreadsheet-header">
                    <div>Ticker <span class="info-icon" onclick="showTickerHelp()">â“˜</span></div><div>Qty</div><div>Type</div><div></div>
                </div>
                <div id="spreadsheetBody"></div>
            </div>
            
            <button class="add-btn" onclick="addMoreHoldings()">+ Add More Holdings</button>
        </div>

        <div class="form-section">
            <h2 class="section-title">Portfolio Categories</h2>
            <div class="groups-display" id="groupsDisplay"></div>
            <div class="group-input-container">
                <input type="text" class="group-input" id="groupInput" placeholder="Add new category...">
                <button class="add-group-btn" onclick="addGroup()">Add</button>
            </div>
        </div>

        <div class="form-section">
            <h2 class="section-title">Snapshot Expiration</h2>
            <p class="section-subtitle">How long should we keep your portfolio accessible?</p>
            <select class="duration-select">
                <option>Forever</option><option>1 Month</option><option>1 Week</option><option>1 Day</option>
            </select>
        </div>

        <div class="form-section">
            <h2 class="section-title">Magic Link</h2>
            <p class="section-subtitle">We'll generate a unique URL to access and edit your portfolio anytime.</p>
            <h3 style="font-size: 1rem; font-weight: 600; margin: 20px 0 8px 0; color: #374151;">Email (Optional)</h3>
            <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 12px;">Enter your email to have the magic link sent to you for easy access.</p>
            <style>
                @media (prefers-color-scheme: dark) {
                    h3[style*="color: #374151"] { color: #f9fafb !important; }
                    p[style*="color: #6b7280"] { color: #9ca3af !important; }
                    p[style*="color: #9ca3af"] { color: #6b7280 !important; }
                }
            </style>
            <input type="email" class="email-input" placeholder="Enter your email address (optional)">
            <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 8px;">We'll only use your email once to send the link. No storage, no spam, no marketing.</p>
        </div>

        <!-- Create button with extra padding to avoid Safari bottom bar -->
        <button class="submit-btn" onclick="createPortfolio()" style="margin-bottom: 80px;">Create Portfolio</button>

        <!-- Delete button (hidden by default, shown in edit mode) -->
        <button id="deleteBtn" class="delete-btn" style="display: none; margin-bottom: 80px;">Delete Portfolio</button>
    </div>

    <script>
        let groups = ['Stocks', 'ETFs', 'Crypto', 'Bonds'];
        let groupColors = { 'Stocks': 'color-stocks', 'ETFs': 'color-etfs', 'Crypto': 'color-crypto', 'Bonds': 'color-bonds', 'REITs': 'color-reits', 'Commodities': 'color-commodities' };
        let holdingsCount = 0;

        function renderGroupTags() {
            const container = document.getElementById('groupsDisplay');
            container.innerHTML = '';
            groups.forEach((group, index) => {
                const tag = document.createElement('div');
                tag.className = `group-tag ${groupColors[group]}`;
                tag.draggable = true;
                tag.dataset.group = group;
                tag.dataset.index = index;
                tag.innerHTML = `<span class="drag-handle">â‹®â‹®</span><span>${group}</span><button class="group-delete" draggable="false" onclick="event.stopPropagation(); removeGroup('${group}')">Ã—</button>`;

                // Add drag event listeners
                tag.addEventListener('dragstart', handleDragStart);
                tag.addEventListener('dragover', handleDragOver);
                tag.addEventListener('drop', handleDrop);
                tag.addEventListener('dragend', handleDragEnd);
                tag.addEventListener('dragenter', handleDragEnter);
                tag.addEventListener('dragleave', handleDragLeave);

                container.appendChild(tag);
            });
        }

        function addGroup() {
            const input = document.getElementById('groupInput');
            const name = input.value.trim();

            // Check for case-insensitive duplicates
            const nameExists = groups.some(existingGroup =>
                existingGroup.toLowerCase() === name.toLowerCase()
            );

            if (name && !nameExists) {
                const colors = ['color-stocks', 'color-etfs', 'color-crypto', 'color-bonds', 'color-reits', 'color-commodities'];
                groupColors[name] = colors[groups.length % colors.length];
                groups.push(name);
                input.value = '';
                renderGroupTags();
                updateDropdowns();
            } else if (name && nameExists) {
                // Show feedback that duplicate was rejected
                input.value = '';
                input.style.borderColor = '#dc2626';
                input.placeholder = 'Category already exists';
                setTimeout(() => {
                    input.style.borderColor = '';
                    input.placeholder = 'Add new category...';
                }, 2000);
            }
        }

        function removeGroup(name) {
            groups = groups.filter(g => g !== name);
            delete groupColors[name];
            renderGroupTags();
            updateDropdowns();
        }

        function updateDropdowns() {
            document.querySelectorAll('.category-select').forEach(select => {
                const current = select.value;
                select.innerHTML = '<option value="">â€”</option>';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    if (group === current) option.selected = true;
                    select.appendChild(option);
                });
            });
        }

        function createRowWithData(data = {}) {
            const container = document.getElementById('spreadsheetBody');
            const row = document.createElement('div');
            row.className = 'spreadsheet-row';

            // Real tickers in alphabetical order
            const alphabetTickers = [
                'AAPL', 'BABA', 'CAT', 'DIS', 'ETSY', 'F', 'GOOGL', 'HD', 'INTC', 'JNJ',
                'KO', 'LMT', 'MSFT', 'NFLX', 'ORCL', 'PG', 'QCOM', 'RTX', 'SPY', 'TSLA',
                'UNH', 'V', 'WMT', 'XOM', 'YUM', 'ZM'
            ];
            const placeholderTicker = data.ticker ? '' : alphabetTickers[holdingsCount % 26];

            row.innerHTML = `
                <div class="spreadsheet-cell">
                    <span class="drag-handle-row">â‹®â‹®</span>
                    <input class="cell-input ticker-input" placeholder="${placeholderTicker}" value="${data.ticker || ''}" style="text-align: left;">
                </div>
                <div class="spreadsheet-cell"><input class="cell-input" type="number" placeholder="100" value="${data.shares || ''}" style="text-align: center;"></div>
                <div class="spreadsheet-cell" style="position:relative; justify-content: center;">
                    <div class="category-dot ${data.group ? groupColors[data.group] || 'color-none' : 'color-none'}" onclick="this.nextElementSibling.click()"></div>
                    <select class="category-select" onchange="updateCategoryDot(this)" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:24px;opacity:0;cursor:pointer;border-radius:50%;">
                        <option value="">â€”</option>
                        ${groups.map(g => `<option value="${g}" ${g === (data.group || '') ? 'selected' : ''}>${g}</option>`).join('')}
                    </select>
                </div>
                <div class="spreadsheet-cell"><button class="row-delete" onclick="this.closest('.spreadsheet-row').remove()">Ã—</button></div>
            `;
            container.appendChild(row);
            holdingsCount++;

            // Add validation to ticker input
            const tickerInput = row.querySelector('.ticker-input');
            setupTickerValidation(tickerInput);

            // Add drag and drop functionality
            addRowDragHandlers(row);
        }

        // Simplified drag and drop for holdings rows
        function addRowDragHandlers(row) {
            const dragHandle = row.querySelector('.drag-handle-row');

            // Make the drag handle itself draggable
            dragHandle.draggable = true;

            dragHandle.addEventListener('dragstart', (e) => {
                row.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', row.outerHTML);
                // Store reference to the row being dragged
                window.draggedRow = row;
            });

            dragHandle.addEventListener('dragend', () => {
                row.classList.remove('dragging');
                window.draggedRow = null;
            });

            row.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            row.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggedElement = window.draggedRow;
                if (draggedElement && draggedElement !== row) {
                    const container = document.getElementById('spreadsheetBody');
                    const rect = row.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;

                    if (e.clientY < midpoint) {
                        container.insertBefore(draggedElement, row);
                    } else {
                        container.insertBefore(draggedElement, row.nextSibling);
                    }
                }
            });
        }

        function updateCategoryDot(select) {
            const dot = select.previousElementSibling;
            const group = select.value;
            dot.className = `category-dot ${group ? groupColors[group] : 'color-none'}`;
        }

        function addMoreHoldings() {
            for(let i = 0; i < 3; i++) {
                createRowWithData();
            }
        }

        async function createPortfolio() {
            // Check if all tickers are valid before proceeding
            if (!areAllTickersValid()) {
                alert('Please fix invalid tickers (red borders) before creating your portfolio');
                return;
            }

            const data = collectFormData();
            if (!data.holdings.length) {
                alert('Please add at least one holding');
                return;
            }
            
            try {
                const response = await fetch('/api/portfolios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Redirect to success page with both URLs
                    const params = new URLSearchParams({
                        viewUrl: result.viewUrl,
                        editUrl: result.editUrl
                    });
                    window.location.href = `/success.html?${params.toString()}`;
                } else {
                    alert('Error creating portfolio: ' + result.error);
                }
            } catch (error) {
                alert('Error creating portfolio: ' + error.message);
            }
        }

        // Initialize with empty rows (no prefilled data)
        function loadWithDummyData() {
            // Create 3 empty rows for faster initial load
            for(let i = 0; i < 3; i++) {
                createRowWithData();
            }
        }

        // Ticker validation functions
        let validationTimeouts = new Map();

        async function validateTicker(input, ticker) {
            if (!ticker.trim()) {
                input.classList.remove('valid', 'invalid', 'validating');
                return;
            }

            input.classList.add('validating');
            input.classList.remove('valid', 'invalid');

            try {
                // Get the category from the same row for context-aware validation
                const row = input.closest('.spreadsheet-row');
                const categorySelect = row?.querySelector('select[name="category"]');
                const category = categorySelect?.value || '';

                let url = `/api/validate-ticker/${encodeURIComponent(ticker)}`;
                if (category) {
                    url += `?category=${encodeURIComponent(category)}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                // Remove validating state
                input.classList.remove('validating');

                if (result.valid) {
                    input.classList.add('valid');
                    input.classList.remove('invalid');
                } else {
                    input.classList.add('invalid');
                    input.classList.remove('valid');
                }
            } catch (error) {
                console.error('Validation error:', error);
                input.classList.remove('validating');
                input.classList.add('invalid');
                input.classList.remove('valid');
            }
        }

        function setupTickerValidation(input) {
            input.addEventListener('input', (e) => {
                const ticker = e.target.value.trim().toUpperCase();

                // Clear previous timeout
                if (validationTimeouts.has(input)) {
                    clearTimeout(validationTimeouts.get(input));
                }

                // Fast debounce validation for snappy UX
                const timeout = setTimeout(() => {
                    validateTicker(input, ticker);
                    validationTimeouts.delete(input);
                }, 150);

                validationTimeouts.set(input, timeout);
            });

            // Validate on blur as well
            input.addEventListener('blur', () => {
                const ticker = input.value.trim().toUpperCase();
                if (ticker) {
                    validateTicker(input, ticker);
                }
            });
        }

        function areAllTickersValid() {
            const tickerInputs = document.querySelectorAll('.ticker-input');
            let hasAnyTickers = false;

            for (const input of tickerInputs) {
                const ticker = input.value.trim();
                if (ticker) {
                    hasAnyTickers = true;
                    if (!input.classList.contains('valid')) {
                        return false;
                    }
                }
            }

            return hasAnyTickers; // Must have at least one ticker and all must be valid
        }

        // Initialize
        renderGroupTags();
        // Check if we're in edit mode
        async function checkEditMode() {
            const path = window.location.pathname;
            const editMatch = path.match(/^\/edit\/([^\/]+)\/([^\/]+)$/);

            if (editMatch) {
                const [, portfolioId, editSecret] = editMatch;
                await loadPortfolioForEdit(portfolioId, editSecret);
            } else {
                loadWithDummyData();
            }
        }

        async function loadPortfolioForEdit(portfolioId, editSecret) {
            try {
                console.log('Loading portfolio for edit:', portfolioId);
                const response = await fetch(`/api/edit/${portfolioId}/${editSecret}`);
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('API result:', result);

                if (result.success) {
                    const portfolio = result.portfolio;

                    // Update page title
                    document.title = 'Edit Portfolio - Holdings.me';

                    // Update button text and show delete button
                    const submitButton = document.querySelector('.submit-btn');
                    if (submitButton) {
                        submitButton.textContent = 'Update Portfolio';
                        submitButton.onclick = () => updatePortfolio(portfolioId, editSecret);
                    }

                    // Show delete button in edit mode
                    const deleteButton = document.getElementById('deleteBtn');
                    if (deleteButton) {
                        deleteButton.style.display = 'block';
                        deleteButton.onclick = () => confirmDeletePortfolio(portfolioId, editSecret);
                    }

                    // Clear existing rows
                    const tableBody = document.getElementById('spreadsheetBody');
                    console.log('spreadsheetBody element:', tableBody);
                    if (!tableBody) {
                        console.error('spreadsheetBody not found!');
                        throw new Error('Spreadsheet body element not found');
                    }
                    tableBody.innerHTML = '';

                    // Load category order if available (backward compatibility)
                    if (portfolio.categoryOrder) {
                        groups = [...portfolio.categoryOrder];
                    }

                    // Load categories
                    if (portfolio.categories) {
                        groupColors = { ...groupColors, ...portfolio.categories };
                    }

                    // Re-render group tags to reflect loaded order
                    renderGroupTags();

                    // Load portfolio data
                    portfolio.holdings.forEach(holding => {
                        createRowWithData({
                            ticker: holding.ticker,
                            shares: holding.quantity,
                            group: holding.category || 'Stocks'
                        });
                    });

                    // Add empty rows
                    for(let i = 0; i < 3; i++) {
                        createRowWithData();
                    }

                    // Set duration
                    const durationSelect = document.querySelector('select[name="duration"]');
                    if (durationSelect) {
                        durationSelect.value = portfolio.duration;
                    }

                    // Store edit info for form submission
                    window.editMode = {
                        portfolioId: portfolioId,
                        editSecret: editSecret
                    };

                } else {
                    alert('Invalid edit link or portfolio not found');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error loading portfolio for edit:', error);
                alert('Error loading portfolio for edit');
                window.location.href = '/';
            }
        }

        // Drag and drop handlers for category reordering
        let draggedElement = null;
        let draggedIndex = null;

        function handleDragStart(e) {
            // Don't start drag if clicking on delete button
            if (e.target.classList.contains('group-delete')) {
                e.preventDefault();
                return false;
            }

            e.stopPropagation();
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', ''); // Minimal data to satisfy HTML5 drag API
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.stopPropagation();
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            if (this !== draggedElement && draggedElement) {
                const dropIndex = parseInt(this.dataset.index);

                // Reorder the groups array
                const draggedGroup = groups[draggedIndex];
                groups.splice(draggedIndex, 1);
                groups.splice(dropIndex, 0, draggedGroup);

                // Re-render the tags with new order
                renderGroupTags();

                // Update all holding dropdowns to reflect new order
                updateCategoryDropdowns();
            }

            return false;
        }

        function handleDragEnd(e) {
            e.preventDefault();
            e.stopPropagation();

            // Clean up visual states
            document.querySelectorAll('.group-tag').forEach(tag => {
                tag.classList.remove('dragging', 'drag-over');
            });

            draggedElement = null;
            draggedIndex = null;
        }

        // Helper function to collect form data (used by both create and update)
        function collectFormData() {
            // Collect holdings data
            const holdings = [];
            document.querySelectorAll('.spreadsheet-row').forEach(row => {
                const inputs = row.querySelectorAll('.cell-input');
                const ticker = inputs[0].value.trim();
                const quantity = inputs[1].value;
                const category = row.querySelector('.category-select').value;

                if (ticker) {
                    holdings.push({
                        ticker: ticker.toUpperCase(),
                        quantity: parseFloat(quantity) || 0,
                        category: category || null
                    });
                }
            });

            // Get other form data
            const duration = document.querySelector('.duration-select').value;
            const email = document.querySelector('.email-input').value.trim();

            return {
                holdings,
                categories: groupColors,
                categoryOrder: groups,
                duration,
                email: email || null
            };
        }

        // Modified form submission to handle edit mode
        const originalCreatePortfolio = createPortfolio;
        window.createPortfolio = async function() {
            if (window.editMode) {
                await updatePortfolio();
            } else {
                await originalCreatePortfolio();
            }
        };

        async function updatePortfolio() {
            // Check if all tickers are valid before proceeding
            if (!areAllTickersValid()) {
                alert('Please fix invalid tickers (red borders) before updating your portfolio');
                return;
            }

            const data = collectFormData();
            if (!data.holdings.length) {
                alert('Please add at least one holding');
                return;
            }

            try {
                const response = await fetch(`/api/portfolios/${window.editMode.portfolioId}/${window.editMode.editSecret}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // Redirect to success page with updated URLs
                    const params = new URLSearchParams({
                        viewUrl: result.viewUrl,
                        editUrl: result.editUrl,
                        updated: 'true'
                    });
                    window.location.href = `/success.html?${params.toString()}`;
                } else {
                    alert('Error updating portfolio: ' + result.error);
                }
            } catch (error) {
                alert('Error updating portfolio: ' + error.message);
            }
        }

        // Prevent zoom gestures and double-tap zoom
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });
        document.addEventListener('gesturechange', function (e) {
            e.preventDefault();
        });
        document.addEventListener('gestureend', function (e) {
            e.preventDefault();
        });

        // Prevent double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Ticker help function
        function showTickerHelp() {
            alert(
                'ðŸ“ˆ Ticker Symbol Help\n\n' +
                'â€¢ STOCKS: Use standard symbols (AAPL, GOOGL, TSLA)\n' +
                'â€¢ CRYPTO: Use coin names (BTC, ETH, SOL, AAVE, LINK)\n' +
                '  Format: BTC-USD, ETH-USD (we add -USD automatically)\n' +
                'â€¢ ETFs: Use full symbols (SPY, QQQ, VTI)\n\n' +
                'ðŸ’¡ SMART VALIDATION:\n' +
                '  - Select the correct category first for accurate validation\n' +
                '  - If category is "Crypto", we\'ll automatically add -USD\n' +
                '  - Set quantity to 0 to create a watchlist\n\n' +
                'âœ¨ This solves conflicts like BTC (Bitcoin vs. stock) - just select the right category!'
            );
        }

        // Delete portfolio functions
        function confirmDeletePortfolio(portfolioId, editSecret) {
            const confirmation = confirm(
                'Are you sure you want to delete this portfolio?\n\n' +
                'This action cannot be undone and will permanently remove all your holdings data.\n\n' +
                'Click OK to delete or Cancel to keep your portfolio.'
            );

            if (confirmation) {
                deletePortfolioConfirmed(portfolioId, editSecret);
            }
        }

        async function deletePortfolioConfirmed(portfolioId, editSecret) {
            try {
                const deleteButton = document.getElementById('deleteBtn');
                const originalText = deleteButton.textContent;
                deleteButton.textContent = 'Deleting...';
                deleteButton.disabled = true;

                const response = await fetch(`/api/portfolios/${portfolioId}/${editSecret}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Portfolio deleted successfully!');
                    window.location.href = '/';
                } else {
                    alert('Error deleting portfolio: ' + result.error);
                    deleteButton.textContent = originalText;
                    deleteButton.disabled = false;
                }
            } catch (error) {
                alert('Error deleting portfolio: ' + error.message);
                const deleteButton = document.getElementById('deleteBtn');
                deleteButton.textContent = 'Delete Portfolio';
                deleteButton.disabled = false;
            }
        }

        // Initialize page
        checkEditMode();
    </script>
</body>
</html>